@page "/employer-panel"
@model Agrojob.Pages.EmployerManagement.EmployerManagementMenuModel
@{
    ViewData["Title"] = "Панель работодателя";
    
    // Определяем цвета для статусов откликов
    var statusColors = new Dictionary<string, (string bg, string text)>
    {
        ["pending"] = (bg: "rgba(255, 143, 0, 0.1)", text: "#FF8F00"),
        ["viewed"] = (bg: "rgba(23, 162, 184, 0.1)", text: "#17a2b8"),
        ["invited"] = (bg: "rgba(46, 125, 50, 0.1)", text: "#2E7D32"),
        ["accepted"] = (bg: "rgba(27, 94, 32, 0.1)", text: "#1B5E20"),
        ["rejected"] = (bg: "rgba(220, 53, 69, 0.1)", text: "#dc3545"),
        ["withdrawn"] = (bg: "rgba(107, 114, 128, 0.1)", text: "#6B7280"),
    };
}

<!-- Хлебные крошки -->
<div class="bg-light py-3">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a asp-page="/Index" style="color: #2E7D32;">Главная</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" style="color: #6B7280;">
                    Панель работодателя
                </li>
            </ol>
        </nav>
    </div>
</div>

<!-- Заголовок -->
<section class="py-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="section-title mb-1">Панель работодателя</h1>
                <p style="color: #6B7280;">Управляйте компаниями, вакансиями и откликами</p>
            </div>
            <div>
                <span class="badge py-2 px-3 rounded-pill" style="background-color: #2E7D32; color: #FFFFFF;">
                    <i class="bi bi-building me-1"></i>
                    @(User.Identity?.Name ?? "Пользователь")
                </span>
            </div>
        </div>

        @if (!Model.HasCompanies)
        {
            <!-- Нет компаний - крупный баннер -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" style="border: 1px solid #E0E8E0 !important; background: linear-gradient(135deg, #F8FFF8 0%, #FFFFFF 100%);">
                <div class="card-body p-5 text-center">
                    <div class="mb-4">
                        <i class="bi bi-building fs-1" style="color: #2E7D32; opacity: 0.5;"></i>
                    </div>
                    <h3 class="fw-bold mb-3" style="color: #1C2E1C;">Добро пожаловать в панель работодателя!</h3>
                    <p class="mb-4" style="color: #6B7280; max-width: 500px; margin-left: auto; margin-right: auto; font-size: 1.1rem;">
                        Чтобы начать публиковать вакансии и получать отклики,
                        сначала создайте компанию. Это займет всего несколько минут.
                    </p>
                    <a asp-page="/EmployerManagement/CompanyManagement/CompanyEdit"
                           class="btn btn-primary btn-lg px-5 py-3"
                           style="background-color: #2E7D32; border-color: #2E7D32; font-size: 1.1rem;">
                        <i class="bi bi-plus-circle me-2"></i>Создать первую компанию
                    </a>
                </div>
            </div>
        }

        @if (Model.HasCompanies)
        {
            <!-- Блок выбора компании -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" style="border: 1px solid #E0E8E0 !important;">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h5 class="fw-semibold mb-2" style="color: #1C2E1C;">
                                <i class="bi bi-building me-2" style="color: #2E7D32;"></i>
                                Текущая компания:
                            </h5>
                            @if (Model.SelectedCompany != null)
                            {
                                <div class="d-flex align-items-center">
                                    <span class="fw-bold fs-5" style="color: #2E7D32;">@Model.SelectedCompany.Name</span>
                                    @if (Model.SelectedCompany.IsVerified)
                                    {
                                        <span class="badge ms-2" style="background-color: rgba(46, 125, 50, 0.1); color: #2E7D32;">
                                            <i class="bi bi-check-circle-fill me-1"></i>Подтверждена
                                        </span>
                                    }
                                </div>
                            }
                        </div>
                        <div class="col-md-6 text-md-end">
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#companySelectModal">
                                <i class="bi bi-arrow-repeat me-1"></i> Сменить компанию
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Карточки со счетчиками -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 rounded-4" style="border: 1px solid #E0E8E0 !important;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle p-3" style="background-color: rgba(46, 125, 50, 0.1);">
                                        <i class="bi bi-building fs-3" style="color: #2E7D32;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h3 class="fw-bold mb-0" style="color: #1C2E1C;">@Model.CompaniesCount</h3>
                                    <span style="color: #6B7280;">Компаний</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 rounded-4" style="border: 1px solid #E0E8E0 !important;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle p-3" style="background-color: rgba(255, 143, 0, 0.1);">
                                        <i class="bi bi-briefcase fs-3" style="color: #FF8F00;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h3 class="fw-bold mb-0" style="color: #1C2E1C;">@Model.VacanciesCount</h3>
                                    <span style="color: #6B7280;">Вакансий</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 rounded-4" style="border: 1px solid #E0E8E0 !important;">
                        <div class="card-body p-4">
                            <div class="d-flex align-items-center">
                                <div class="flex-shrink-0">
                                    <div class="rounded-circle p-3" style="background-color: rgba(46, 125, 50, 0.1);">
                                        <i class="bi bi-envelope-paper fs-3" style="color: #2E7D32;"></i>
                                    </div>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h3 class="fw-bold mb-0" style="color: #1C2E1C;">@Model.ApplicationsCount</h3>
                                    <span style="color: #6B7280;">Откликов</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Блок вакансий -->
            <div class="card shadow-sm border-0 rounded-4 mb-4" style="border: 1px solid #E0E8E0 !important;">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="fw-bold mb-0" style="color: #1C2E1C;">
                            <i class="bi bi-briefcase me-2" style="color: #2E7D32;"></i>
                            Вакансии компании @(Model.SelectedCompany?.Name)
                        </h5>
                        <a asp-page="/EmployerManagement/VacancyManagement/VacancyEdit"
                               asp-route-companyId="@Model.SelectedCompanyId"
                               class="btn btn-primary btn-sm rounded-pill px-3"
                               style="background-color: #2E7D32; border-color: #2E7D32;">
                            <i class="bi bi-plus-circle me-1"></i> Создать вакансию
                        </a>
                    </div>
                </div>
                <div class="card-body p-4">
                    @if (Model.Vacancies.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead style="background-color: #F5F9F5;">
                                    <tr>
                                        <th style="color: #1C2E1C;">Название</th>
                                        <th style="color: #1C2E1C;">Локация</th>
                                        <th style="color: #1C2E1C;">Зарплата</th>
                                        <th style="color: #1C2E1C;">Статус</th>
                                        <th style="color: #1C2E1C;">Отклики</th>
                                        <th style="color: #1C2E1C;">Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var vacancy in Model.Vacancies)
                                    {
                                        <tr>
                                            <td class="fw-semibold" style="color: #1C2E1C;">@vacancy.Title</td>
                                            <td style="color: #6B7280;">@vacancy.Location</td>
                                            <td style="color: #2E7D32;">@vacancy.Salary</td>
                                            <td>
                                                @if (vacancy.IsActive)
                                                {
                                                    <span class="badge" style="background-color: rgba(46, 125, 50, 0.1); color: #2E7D32;">
                                                        Активна
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="badge" style="background-color: #F3F6F3; color: #6B7280;">
                                                        Не активна
                                                    </span>
                                                }
                                            </td>
                                            <td>
                                                <a asp-page="/EmployerManagement/ApplicationManagement/VacancyApplications"
                                                       asp-route-vacancyId="@vacancy.Id"
                                                       class="text-decoration-none">
                                                    <span class="badge" style="background-color: rgba(255, 143, 0, 0.1); color: #FF8F00;">
                                                        @vacancy.ApplicationsCount
                                                    </span>
                                                </a>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a asp-page="/EmployerManagement/VacancyManagement/VacancyEdit"
                                                           asp-route-id="@vacancy.Id"
                                                           class="btn btn-outline-primary"
                                                           title="Редактировать"
                                                           style="border-color: #2E7D32; color: #2E7D32;">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                    <a asp-page="/VacancyDetail"
                                                           asp-route-id="@vacancy.Id"
                                                           class="btn btn-outline-primary"
                                                           title="Просмотр"
                                                           style="border-color: #2E7D32; color: #2E7D32;">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <a asp-page="/EmployerManagement/ApplicationManagement/VacancyApplications"
                                                           asp-route-vacancyId="@vacancy.Id"
                                                           class="btn btn-outline-success"
                                                           title="Отклики"
                                                           style="border-color: #2E7D32; color: #2E7D32;">
                                                        <i class="bi bi-envelope-paper"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-4">
                            <p style="color: #6B7280;">У компании пока нет вакансий. Создайте первую вакансию!</p>
                            <a asp-page="/EmployerManagement/VacancyManagement/VacancyEdit"
                                   asp-route-companyId="@Model.SelectedCompanyId"
                                   class="btn btn-primary btn-sm"
                                   style="background-color: #2E7D32; border-color: #2E7D32;">
                                <i class="bi bi-plus-circle me-1"></i> Создать вакансию
                            </a>
                        </div>
                    }
                </div>
            </div>

            <!-- Блок последних откликов -->
            @if (Model.RecentApplications.Any())
            {
                <div class="card shadow-sm border-0 rounded-4 mb-4" style="border: 1px solid #E0E8E0 !important;">
                    <div class="card-header bg-transparent border-0 pt-4 px-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="fw-bold mb-0" style="color: #1C2E1C;">
                                <i class="bi bi-clock-history me-2" style="color: #FF8F00;"></i>
                                Последние отклики - @(Model.SelectedCompany?.Name)
                            </h5>
                            <a asp-page="/EmployerManagement/ApplicationManagement/AllCompanyApplications"
                                   asp-route-companyId="@Model.SelectedCompanyId"
                                   class="btn btn-outline-primary btn-sm rounded-pill px-3"
                                   style="border-color: #2E7D32; color: #2E7D32;">
                                Все отклики
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="list-group list-group-flush">
                            @foreach (var app in Model.RecentApplications)
                            {
                                var colors = statusColors.GetValueOrDefault(app.StatusCode.ToLower(),
                                    (bg: "rgba(107, 114, 128, 0.1)", text: "#6B7280"));
                                
                                <a asp-page="/EmployerManagement/ApplicationManagement/ApplicationDetail"
                                       asp-route-id="@app.Id"
                                       class="list-group-item list-group-item-action border-0 px-0"
                                       style="border-bottom: 1px solid #E0E8E0 !important;">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-person-circle fs-5 me-2" style="color: #2E7D32;"></i>
                                                <div>
                                                    <span class="fw-semibold" style="color: #1C2E1C;">@app.ApplicantName</span>
                                                    <br>
                                                    <small style="color: #6B7280;">@app.AppliedAt.ToString("dd.MM.yyyy HH:mm")</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <span style="color: #1C2E1C;">@app.VacancyTitle</span>
                                            <br>
                                            <small style="color: #6B7280;">@app.CompanyName</small>
                                        </div>
                                        <div class="col-md-3">
                                            <span class="badge" style="background-color: @colors.bg; color: @colors.text;">
                                                @app.Status
                                            </span>
                                        </div>
                                        <div class="col-md-1 text-end">
                                            <i class="bi bi-chevron-right" style="color: #2E7D32;"></i>
                                        </div>
                                    </div>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        }

        <!-- Блок обучения (всегда показываем) -->
        <div class="card shadow-sm border-0 rounded-4" style="border: 1px solid #E0E8E0 !important;">
            <div class="card-header bg-transparent border-0 pt-4 px-4">
                <h5 class="fw-bold mb-0" style="color: #1C2E1C;">
                    <i class="bi bi-mortarboard me-2" style="color: #FF6B35;"></i>
                    Обучение и поддержка
                </h5>
            </div>
            <div class="card-body p-4">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-3 rounded-3" style="background-color: #F5F9F5;">
                            <i class="bi bi-play-circle fs-2 me-3" style="color: #2E7D32;"></i>
                            <div>
                                <h6 class="fw-semibold mb-1" style="color: #1C2E1C;">Видеоинструкции</h6>
                                <small style="color: #6B7280;">Как создать вакансию</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-3 rounded-3" style="background-color: #F5F9F5;">
                            <i class="bi bi-question-circle fs-2 me-3" style="color: #FF8F00;"></i>
                            <div>
                                <h6 class="fw-semibold mb-1" style="color: #1C2E1C;">FAQ</h6>
                                <small style="color: #6B7280;">Часто задаваемые вопросы</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="d-flex align-items-center p-3 rounded-3" style="background-color: #F5F9F5;">
                            <i class="bi bi-headset fs-2 me-3" style="color: #FF6B35;"></i>
                            <div>
                                <h6 class="fw-semibold mb-1" style="color: #1C2E1C;">Поддержка</h6>
                                <small style="color: #6B7280;">Связаться с нами</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 text-center m-4">
            <form method="post" asp-page-handler="BecomeEmployee" style="display: inline;">
                <button type="submit" class="btn btn-outline-secondary">Стать соискателем</button>
            </form>
        </div>

    </div>
</section>

<!-- Модальное окно выбора компании -->
<div class="modal fade" id="companySelectModal" tabindex="-1" aria-labelledby="companySelectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #2E7D32; color: white;">
                <h5 class="modal-title" id="companySelectModalLabel">
                    <i class="bi bi-building me-2"></i>Выберите компанию
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="list-group">
                    @foreach (var company in Model.Companies)
                    {
                        <form method="post" asp-page-handler="SelectCompany" style="display: inline;">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="companyId" value="@company.Id" />
                            <button type="submit" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center @(Model.SelectedCompanyId == company.Id ? "active" : "")"
                                    style="@(Model.SelectedCompanyId == company.Id ? "background-color: #2E7D32; border-color: #2E7D32;" : "")">
                                <div>
                                    <i class="bi bi-building me-2"></i>
                                    <span class="fw-semibold">@company.Name</span>
                                    @if (company.IsVerified)
                                    {
                                        <i class="bi bi-check-circle-fill ms-2" style="color: @(Model.SelectedCompanyId == company.Id ? "white" : "#2E7D32");" title="Подтвержденная компания"></i>
                                    }
                                </div>
                                <span class="badge" style="background-color: @(Model.SelectedCompanyId == company.Id ? "white" : "#2E7D32"); color: @(Model.SelectedCompanyId == company.Id ? "#2E7D32" : "white");">
                                    @company.VacanciesCount вакансий
                                </span>
                            </button>
                        </form>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <a asp-page="/EmployerManagement/CompanyManagement/CompanyEdit" class="btn btn-outline-success">
                    <i class="bi bi-plus-circle me-1"></i> Добавить компанию
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>